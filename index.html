<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Red de Personas</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        /* --- Estructura General --- */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            background-color: #f4f4f9;
        }

        /* --- Panel de Filtros (Izquierda) --- */
        #filters-container {
            width: 280px;
            height: 100vh;
            overflow-y: auto;
            background-color: #ffffff;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        h2 {
            font-size: 1.2em;
            color: #333;
            margin-top: 0;
        }

        .filter-group {
            margin-bottom: 20px;
            border-left-width: 5px;
            border-left-style: solid;
            padding: 10px;
            border-radius: 5px;
            background-color: #fafafa;
        }

        .filter-group summary {
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            color: #333;
        }

        .filter-options {
            padding-top: 10px;
        }

        .filter-options label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #555;
        }
        
        /* Colores de los bordes para cada campo */
        #filters-container .filter-group:nth-of-type(1) { border-color: #4A90E2; } /* Especie */
        #filters-container .filter-group:nth-of-type(2) { border-color: #F5A623; } /* Dispositivo */
        #filters-container .filter-group:nth-of-type(3) { border-color: #50E3C2; } /* Estudio */
        #filters-container .filter-group:nth-of-type(4) { border-color: #BD10E0; } /* Proyecto */
        #filters-container .filter-group:nth-of-type(5) { border-color: #9013FE; } /* Status */
        #filters-container .filter-group:nth-of-type(6) { border-color: #D0021B; } /* Institución */

        /* --- Contenedor de la Red (Derecha) --- */
        #network-container {
            flex-grow: 1;
            height: 100vh;
            position: relative;
        }

        #mynetwork {
            width: 100%;
            height: 100%;
        }
        
        /* --- Tarjeta de Información de la Persona --- */
        #person-card {
            display: none; /* Oculta por defecto */
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            padding: 20px;
            z-index: 100;
        }
        #person-card h3 {
            margin-top: 0;
            color: #D0021B; /* Color de Institución */
        }
        #person-card-content p {
            margin: 10px 0;
        }
        #person-card-content strong {
            color: #333;
        }
        #close-card {
            position: absolute;
            top: 10px;
            right: 15px;
            border: none;
            background: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #888;
        }

    </style>
</head>
<body>

    <div id="filters-container">
        <h2>Filtros</h2>
    </div>

    <div id="network-container">
        <div id="mynetwork"></div>
        <div id="person-card">
             <button id="close-card">&times;</button>
             <h3 id="person-card-name"></h3>
             <div id="person-card-content"></div>
        </div>
    </div>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function () {
    // --- BASE DE DATOS DE EJEMPLO (15 PERSONAS) ---
    const peopleData = [
        { name: "Ana Torres", institution: "UPV", status: "IP", species: ["Ovina", "Caprina"], devices: ["RFID", "Collares"], studies: ["Comportamiento social"], projects: ["Project1"] },
        { name: "Beatriz Ruiz", institution: "UPV", status: "Postdoc", species: ["Ovina"], devices: ["Collares", "Cámaras de visión"], studies: ["Manejo"], projects: ["Project1", "Project3"] },
        { name: "Carlos Sanz", institution: "UPV", status: "Predoc", species: ["Caprina"], devices: ["RFID", "Sensores de movimiento"], studies: ["Comportamiento alimenticio"], projects: ["Project1"] },
        { name: "David Gil", institution: "UdL", status: "IP", species: ["Porcina", "Avícola"], devices: ["Alimentadores automáticos", "IA", "Básculas"], studies: ["Nutrición"], projects: ["Project2"] },
        { name: "Elena Vidal", institution: "UdL", status: "Técnico", species: ["Porcina"], devices: ["Básculas", "Sensores acústicos"], studies: ["Salud"], projects: ["Project2", "Project4"] },
        { name: "Felipe Mora", institution: "UCO", status: "IP", species: ["Vacuna"], devices: ["Drones", "Vallados virtuales", "Collares"], studies: ["Manejo"], projects: ["Project3"] },
        { name: "Gloria Pons", institution: "UCO", status: "Postdoc", species: ["Vacuna", "Ovina"], devices: ["Drones", "RFID"], studies: ["Comportamiento social"], projects: ["Project3"] },
        { name: "Hector Luna", institution: "USAL", status: "IP", species: ["Cunícula"], devices: ["Cámaras de visión", "Sensores de movimiento"], studies: ["Comportamiento alimenticio"], projects: ["Project4"] },
        { name: "Irene Soler", institution: "UAB", status: "IP", species: ["Avícola"], devices: ["IA", "Alimentadores automáticos"], studies: ["Nutrición", "Salud"], projects: ["Project2"] },
        { name: "Javier Peña", institution: "UAB", status: "Predoc", species: ["Avícola"], devices: ["IA", "Sensores acústicos"], studies: ["Salud"], projects: ["Project2"] },
        { name: "Laura Camps", institution: "UdL", status: "Postdoc", species: ["Porcina"], devices: ["IA", "Básculas"], studies: ["Nutrición"], projects: ["Project2", "Project4"] },
        { name: "Marcos Roca", institution: "UPV", status: "Técnico", species: ["Ovina"], devices: ["RFID"], studies: ["Manejo"], projects: ["Project1"] },
        { name: "Nuria Blasco", institution: "UCO", status: "Predoc", species: ["Vacuna"], devices: ["Collares"], studies: ["Manejo", "Comportamiento social"], projects: ["Project3"] },
        { name: "Oscar Romero", institution: "USAL", status: "Postdoc", species: ["Cunícula", "Porcina"], devices: ["Cámaras de visión", "IA"], studies: ["Comportamiento alimenticio", "Salud"], projects: ["Project4"] },
        { name: "Pilar Fuster", institution: "UAB", status: "IP", species: ["Caprina", "Ovina"], devices: ["RFID", "Drones"], studies: ["Comportamiento social", "Manejo"], projects: ["Project1", "Project3"] }
    ];

    // --- CONFIGURACIÓN DE LOS FILTROS ---
    const filtersConfig = {
        'Especie': ['Ovina', 'Caprina', 'Vacuna', 'Porcina', 'Avícola', 'Cunícula'],
        'Dispositivo': ['Drones', 'RFID', 'Collares', 'Cámaras de visión', 'IA', 'Alimentadores automáticos', 'Básculas', 'Sensores acústicos', 'Sensores de movimiento', 'Vallados virtuales'],
        'Estudio': ['Comportamiento alimenticio', 'Comportamiento social', 'Manejo', 'Nutrición', 'Salud'],
        'Proyecto': ['Project1', 'Project2', 'Project3', 'Project4'],
        'Status': ['IP', 'Predoc', 'Postdoc', 'Técnico'],
        'Institución': ['UPV', 'UdL', 'UCO', 'USAL', 'UAB']
    };
    
    // --- INICIALIZACIÓN DE LA APLICACIÓN ---
    const filtersContainer = document.getElementById('filters-container');
    const networkContainer = document.getElementById('mynetwork');
    const personCard = document.getElementById('person-card');
    const personCardName = document.getElementById('person-card-name');
    const personCardContent = document.getElementById('person-card-content');
    const closeCardButton = document.getElementById('close-card');
    
    let network = null;
    
    // 1. Crear los filtros dinámicamente
    function createFilters() {
        for (const groupName in filtersConfig) {
            const groupDiv = document.createElement('details');
            groupDiv.className = 'filter-group';
            groupDiv.open = true; // Empiezan abiertos
            
            const summary = document.createElement('summary');
            summary.textContent = groupName;
            groupDiv.appendChild(summary);

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'filter-options';
            
            filtersConfig[groupName].forEach(option => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = option;
                checkbox.dataset.group = groupName.toLowerCase(); // ej: data-group="especie"
                label.appendChild(checkbox);
                label.append(` ${option}`);
                optionsDiv.appendChild(label);
            });
            groupDiv.appendChild(optionsDiv);
            filtersContainer.appendChild(groupDiv);
        }
    }

    // 2. Función principal para actualizar la red
    function updateNetwork() {
        const selectedFilters = Array.from(document.querySelectorAll('#filters-container input:checked')).map(cb => ({
             value: cb.value,
             group: cb.dataset.group
        }));

        // Filtrar personas: deben coincidir con AL MENOS UNO de los filtros seleccionados
        let filteredPeople;
        if (selectedFilters.length === 0) {
            filteredPeople = []; // No mostrar nada si no hay filtros, o mostrar todos: peopleData
        } else {
            const selectedValues = new Set(selectedFilters.map(f => f.value));
            filteredPeople = peopleData.filter(person => 
                person.species.some(s => selectedValues.has(s)) ||
                person.devices.some(d => selectedValues.has(d)) ||
                person.studies.some(st => selectedValues.has(st)) ||
                person.projects.some(p => selectedValues.has(p)) ||
                selectedValues.has(person.status) ||
                selectedValues.has(person.institution)
            );
        }

        // Crear Nodos (Personas)
        const institutionIPs = {}; // Rastrear IPs por institución para el tamaño
        filteredPeople.forEach(p => {
            if (p.status === 'IP') {
                if (!institutionIPs[p.institution]) institutionIPs[p.institution] = [];
                institutionIPs[p.institution].push(p.name);
            }
        });

        const nodes = new vis.DataSet(filteredPeople.map(person => {
            let size = 25; // Tamaño por defecto
            // Regla especial: si hay un IP en la misma institución, los no-IP son más pequeños
            if (person.status !== 'IP' && institutionIPs[person.institution]) {
                size = 15; // Tamaño reducido "satelital"
            }
            return {
                id: person.name,
                label: person.name,
                title: `${person.name} (${person.institution} - ${person.status})`,
                size: size,
                group: person.institution // Agrupa visualmente por institución
            };
        }));

        // Crear Conexiones (Edges)
        const edges = new vis.DataSet();
        const createdEdges = new Set(); // Para evitar duplicados (A-B y B-A)

        // Comparamos cada persona con todas las demás
        for (let i = 0; i < filteredPeople.length; i++) {
            for (let j = i + 1; j < filteredPeople.length; j++) {
                const personA = filteredPeople[i];
                const personB = filteredPeople[j];

                // Buscar indicadores comunes basados en los filtros seleccionados
                const commonIndicators = [];
                selectedFilters.forEach(filter => {
                    const checkProperty = (obj, prop, value) => {
                         if (Array.isArray(obj[prop])) return obj[prop].includes(value);
                         return obj[prop] === value;
                    };
                    
                    const pA_props = { species: personA.species, dispositivo: personA.devices, estudio: personA.studies, proyecto: personA.projects, status: personA.status, institución: personA.institution };
                    const pB_props = { species: personB.species, dispositivo: personB.devices, estudio: personB.studies, proyecto: personB.projects, status: personB.status, institución: personB.institution };

                    if (checkProperty(pA_props, filter.group, filter.value) && checkProperty(pB_props, filter.group, filter.value)) {
                       commonIndicators.push(filter.value);
                    }
                });

                if (commonIndicators.length > 0) {
                    const edgeId = [personA.name, personB.name].sort().join('-');
                    if (!createdEdges.has(edgeId)) {
                        edges.add({
                            from: personA.name,
                            to: personB.name,
                            // Etiqueta para saber el tipo de conexión
                            title: `Conexión por: ${commonIndicators.join(', ')}`,
                            label: `🔗` // Un emoji simple o `...`
                        });
                        createdEdges.add(edgeId);
                    }
                }
            }
        }
        
        // Renderizar la red
        const data = { nodes: nodes, edges: edges };
        const options = {
            nodes: {
                shape: 'dot',
                font: { size: 14, color: '#333' },
                borderWidth: 2
            },
            edges: {
                width: 1,
                color: { inherit: 'from' },
                smooth: { type: 'continuous' }
            },
            physics: {
                forceAtlas2Based: {
                    gravitationalConstant: -50,
                    centralGravity: 0.01,
                    springLength: 230,
                    springConstant: 0.08
                },
                minVelocity: 0.75,
                solver: 'forceAtlas2Based'
            },
            interaction: {
                tooltipDelay: 200,
                hideEdgesOnDrag: true
            },
            // Agrupar visualmente por institución con colores
            groups: {
              UPV: { color: { background:'#4A90E2', border:'#3B73B4' }, borderWidth: 3 },
              UdL: { color: { background:'#F5A623', border:'#C4851C' } },
              UCO: { color: { background:'#50E3C2', border:'#40B59B' } },
              USAL: { color: { background:'#BD10E0', border:'#970DB2' } },
              UAB: { color: { background:'#9013FE', border:'#730FCB' } }
            }
        };

        if (!network) {
            network = new vis.Network(networkContainer, data, options);
            // Evento de clic en un nodo
            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    showPersonCard(nodeId);
                } else {
                    hidePersonCard(); // Ocultar si se hace clic en el fondo
                }
            });
        } else {
            network.setData(data);
        }
    }
    
    // 3. Mostrar/ocultar tarjeta de detalles
    function showPersonCard(personName) {
        const person = peopleData.find(p => p.name === personName);
        if (person) {
            personCardName.textContent = person.name;
            personCardContent.innerHTML = `
                <p><strong>Institución:</strong> ${person.institution}</p>
                <p><strong>Status:</strong> ${person.status}</p>
                <p><strong>Especies:</strong> ${person.species.join(', ')}</p>
                <p><strong>Dispositivos:</strong> ${person.devices.join(', ')}</p>
                <p><strong>Estudios:</strong> ${person.studies.join(', ')}</p>
                <p><strong>Proyectos:</strong> ${person.projects.join(', ')}</p>
            `;
            personCard.style.display = 'block';
        }
    }

    function hidePersonCard() {
        personCard.style.display = 'none';
    }

    // --- Arranque de la Lógica ---
    createFilters();
    updateNetwork(); // Llama una vez al inicio para mostrar la red vacía o inicial

    // Añadir el listener que actualiza la red cada vez que se marca/desmarca una casilla
    filtersContainer.addEventListener('change', updateNetwork);
    closeCardButton.addEventListener('click', hidePersonCard);
});
</script>

</body>
</html>
