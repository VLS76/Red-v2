<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red de Investigadores</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --especie-color: #4CAF50;
            --tecnologia-color: #2196F3;
            --lineas-color: #9C27B0;
            --rol-color: #FF9800;
            --institucion-color: #F44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a4d69);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .content {
            display: flex;
            gap: 25px;
        }
        
        /* Filter Panel Styles */
        .filter-panel {
            width: 300px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .filter-tab {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .tab-header {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .tab-header:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .tab-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 0 10px 10px;
        }
        
        .tab-content.active {
            max-height: 500px;
        }
        
        .filter-options {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .filter-option {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        
        .filter-option input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        .filter-option label {
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .filter-option label:hover {
            color: #ffcc00;
        }
        
        .select-all {
            display: block;
            margin-top: 10px;
            color: #64B5F6;
            cursor: pointer;
            text-align: right;
            font-size: 0.9rem;
        }
        
        /* Visualization Area */
        .visualization {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            height: 80vh;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        #network {
            width: 100%;
            height: 100%;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 10px;
            padding: 15px;
            pointer-events: none;
            max-width: 300px;
            backdrop-filter: blur(5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        
        .tooltip h3 {
            color: #FF9800;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        .tooltip-section {
            margin-bottom: 10px;
        }
        
        .tooltip-section h4 {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #64B5F6;
        }
        
        .tooltip-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .indicator-tag {
            background: rgba(100, 181, 246, 0.2);
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        /* Color-specific styles */
        .especie { border-left: 5px solid var(--especie-color); }
        .tecnologia { border-left: 5px solid var(--tecnologia-color); }
        .lineas { border-left: 5px solid var(--lineas-color); }
        .rol { border-left: 5px solid var(--rol-color); }
        .institucion { border-left: 5px solid var(--institucion-color); }
        
        .especie .tab-header { background: rgba(76, 175, 80, 0.15); }
        .tecnologia .tab-header { background: rgba(33, 150, 243, 0.15); }
        .lineas .tab-header { background: rgba(156, 39, 176, 0.15); }
        .rol .tab-header { background: rgba(255, 152, 0, 0.15); }
        .institucion .tab-header { background: rgba(244, 67, 54, 0.15); }
        
        .especie .legend-color { background: var(--especie-color); }
        .tecnologia .legend-color { background: var(--tecnologia-color); }
        .lineas .legend-color { background: var(--lineas-color); }
        .rol .legend-color { background: var(--rol-color); }
        .institucion .legend-color { background: var(--institucion-color); }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
            }
            
            .filter-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Red de Investigadores</h1>
            <p class="subtitle">Explore las conexiones entre investigadores según sus áreas de especialización, tecnología utilizada, líneas de investigación, roles e instituciones.</p>
        </header>
        
        <div class="content">
            <div class="filter-panel">
                <div class="filter-tab especie">
                    <div class="tab-header" onclick="toggleTab('especie')">
                        <span>Especie</span>
                        <span>▼</span>
                    </div>
                    <div class="tab-content" id="especie-content">
                        <div class="filter-options">
                            <div class="filter-option">
                                <input type="checkbox" id="especie-ov" value="Ovina" checked>
                                <label for="especie-ov">Ovina</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="especie-cap" value="Caprina" checked>
                                <label for="especie-cap">Caprina</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="especie-vac" value="Vacuna" checked>
                                <label for="especie-vac">Vacuna</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="especie-por" value="Porcina" checked>
                                <label for="especie-por">Porcina</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="especie-avi" value="Avícola" checked>
                                <label for="especie-avi">Avícola</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="especie-cun" value="Cunícula" checked>
                                <label for="especie-cun">Cunícula</label>
                            </div>
                            <span class="select-all" onclick="toggleAll('especie', true)">Seleccionar todos</span>
                            <span class="select-all" onclick="toggleAll('especie', false)">Deseleccionar todos</span>
                        </div>
                    </div>
                </div>
                
                <div class="filter-tab tecnologia">
                    <div class="tab-header" onclick="toggleTab('tecnologia')">
                        <span>Tecnología</span>
                        <span>▼</span>
                    </div>
                    <div class="tab-content" id="tecnologia-content">
                        <div class="filter-options">
                            <div class="filter-option">
                                <input type="checkbox" id="tec-id" value="Identificación y monitorización" checked>
                                <label for="tec-id">Identificación y monitorización</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="tec-det" value="Detección y medición" checked>
                                <label for="tec-det">Detección y medición</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="tec-bio" value="Biosensores" checked>
                                <label for="tec-bio">Biosensores</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="tec-pos" value="Posicionamiento y navegación" checked>
                                <label for="tec-pos">Posicionamiento y navegación</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="tec-aut" value="Automatización y robots" checked>
                                <label for="tec-aut">Automatización y robots</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="tec-img" value="Análisis de imágenes" checked>
                                <label for="tec-img">Análisis de imágenes</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="tec-dat" value="Ciencia de datos" checked>
                                <label for="tec-dat">Ciencia de datos</label>
                            </div>
                            <span class="select-all" onclick="toggleAll('tecnologia', true)">Seleccionar todos</span>
                            <span class="select-all" onclick="toggleAll('tecnologia', false)">Deseleccionar todos</span>
                        </div>
                    </div>
                </div>
                
                <div class="filter-tab lineas">
                    <div class="tab-header" onclick="toggleTab('lineas')">
                        <span>Lineas</span>
                        <span>▼</span>
                    </div>
                    <div class="tab-content" id="lineas-content">
                        <div class="filter-options">
                            <div class="filter-option">
                                <input type="checkbox" id="lineas-salud" value="Salud animal" checked>
                                <label for="lineas-salud">Salud animal</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="lineas-opt" value="Optimización de recursos" checked>
                                <label for="lineas-opt">Optimización de recursos</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="lineas-com" value="Comportamiento animal" checked>
                                <label for="lineas-com">Comportamiento animal</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="lineas-mon" value="Monitoreo de emisiones" checked>
                                <label for="lineas-mon">Monitoreo de emisiones</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="lineas-rep" value="Reproducción y mejora genética" checked>
                                <label for="lineas-rep">Reproducción y mejora genética</label>
                            </div>
                            <span class="select-all" onclick="toggleAll('lineas', true)">Seleccionar todos</span>
                            <span class="select-all" onclick="toggleAll('lineas', false)">Deseleccionar todos</span>
                        </div>
                    </div>
                </div>
                
                <div class="filter-tab rol">
                    <div class="tab-header" onclick="toggleTab('rol')">
                        <span>Rol</span>
                        <span>▼</span>
                    </div>
                    <div class="tab-content" id="rol-content">
                        <div class="filter-options">
                            <div class="filter-option">
                                <input type="checkbox" id="rol-ip" value="IP" checked>
                                <label for="rol-ip">IP</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="rol-post" value="Postdoc" checked>
                                <label for="rol-post">Postdoc</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="rol-pre" value="Predoc" checked>
                                <label for="rol-pre">Predoc</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="rol-tec" value="Técnico" checked>
                                <label for="rol-tec">Técnico</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="rol-ase" value="Asesor científico" checked>
                                <label for="rol-ase">Asesor científico</label>
                            </div>
                            <span class="select-all" onclick="toggleAll('rol', true)">Seleccionar todos</span>
                            <span class="select-all" onclick="toggleAll('rol', false)">Deseleccionar todos</span>
                        </div>
                    </div>
                </div>
                
                <div class="filter-tab institucion">
                    <div class="tab-header" onclick="toggleTab('institucion')">
                        <span>Institución</span>
                        <span>▼</span>
                    </div>
                    <div class="tab-content" id="institucion-content">
                        <div class="filter-options">
                            <div class="filter-option">
                                <input type="checkbox" id="inst-cic" value="CICYTEX" checked>
                                <label for="inst-cic">CICYTEX</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-csic" value="CSIC/INIA" checked>
                                <label for="inst-csic">CSIC/INIA</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-irta" value="IRTA" checked>
                                <label for="inst-irta">IRTA</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-iuca" value="IUCA" checked>
                                <label for="inst-iuca">IUCA</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-neik" value="NEIKER" checked>
                                <label for="inst-neik">NEIKER</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-uab" value="UAB" checked>
                                <label for="inst-uab">UAB</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-uco" value="UCO" checked>
                                <label for="inst-uco">UCO</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-udl" value="UdL/Agrotecnio" checked>
                                <label for="inst-udl">UdL/Agrotecnio</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-um" value="UM" checked>
                                <label for="inst-um">UM</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-usal" value="USAL" checked>
                                <label for="inst-usal">USAL</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-usc" value="USC/Campus Terra" checked>
                                <label for="inst-usc">USC/Campus Terra</label>
                            </div>
                            <div class="filter-option">
                                <input type="checkbox" id="inst-upv" value="UPV" checked>
                                <label for="inst-upv">UPV</label>
                            </div>
                            <span class="select-all" onclick="toggleAll('institucion', true)">Seleccionar todos</span>
                            <span class="select-all" onclick="toggleAll('institucion', false)">Deseleccionar todos</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="visualization">
                <div id="network"></div>
                <div class="legend">
                    <div class="legend-item especie">
                        <div class="legend-color"></div>
                        <span>Especie</span>
                    </div>
                    <div class="legend-item tecnologia">
                        <div class="legend-color"></div>
                        <span>Tecnología</span>
                    </div>
                    <div class="legend-item lineas">
                        <div class="legend-color"></div>
                        <span>Lineas</span>
                    </div>
                    <div class="legend-item rol">
                        <div class="legend-color"></div>
                        <span>Rol</span>
                    </div>
                    <div class="legend-item institucion">
                        <div class="legend-color"></div>
                        <span>Institución</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tooltip"></div>
    
    <script>
        // Sample data for 15 people
        const peopleData = [
            {
                id: 1,
                name: "Dra. Elena Martínez",
                institution: "CICYTEX",
                role: "IP",
                especie: ["Ovina", "Caprina"],
                tecnologia: ["Identificación y monitorización", "Ciencia de datos"],
                lineas: ["Salud animal", "Optimización de recursos"],
                rol: ["IP"]
            },
            {
                id: 2,
                name: "Dr. Javier López",
                institution: "CSIC/INIA",
                role: "IP",
                especie: ["Vacuna", "Porcina"],
                tecnologia: ["Biosensores", "Análisis de imágenes"],
                lineas: ["Comportamiento animal", "Monitoreo de emisiones"],
                rol: ["IP"]
            },
            {
                id: 3,
                name: "Dr. Carlos Rodríguez",
                institution: "IRTA",
                role: "IP",
                especie: ["Avícola", "Cunícula"],
                tecnologia: ["Posicionamiento y navegación", "Automatización y robots"],
                lineas: ["Reproducción y mejora genética", "Salud animal"],
                rol: ["IP"]
            },
            {
                id: 4,
                name: "Dra. Ana García",
                institution: "IUCA",
                role: "Postdoc",
                especie: ["Ovina"],
                tecnologia: ["Ciencia de datos"],
                lineas: ["Optimización de recursos"],
                rol: ["Postdoc"]
            },
            {
                id: 5,
                name: "Dr. Miguel Sánchez",
                institution: "NEIKER",
                role: "Predoc",
                especie: ["Caprina"],
                tecnologia: ["Detección y medición"],
                lineas: ["Comportamiento animal"],
                rol: ["Predoc"]
            },
            {
                id: 6,
                name: "Sra. Laura Fernández",
                institution: "UAB",
                role: "Técnico",
                especie: ["Vacuna"],
                tecnologia: ["Biosensores"],
                lineas: ["Monitoreo de emisiones"],
                rol: ["Técnico"]
            },
            {
                id: 7,
                name: "Dr. Pablo Gómez",
                institution: "UCO",
                role: "Asesor científico",
                especie: ["Porcina"],
                tecnologia: ["Análisis de imágenes"],
                lineas: ["Reproducción y mejora genética"],
                rol: ["Asesor científico"]
            },
            {
                id: 8,
                name: "Dra. Sara Díaz",
                institution: "UdL/Agrotecnio",
                role: "IP",
                especie: ["Avícola"],
                tecnologia: ["Posicionamiento y navegación"],
                lineas: ["Salud animal"],
                rol: ["IP"]
            },
            {
                id: 9,
                name: "Dr. Roberto Jiménez",
                institution: "UM",
                role: "Postdoc",
                especie: ["Cunícula"],
                tecnologia: ["Automatización y robots"],
                lineas: ["Optimización de recursos"],
                rol: ["Postdoc"]
            },
            {
                id: 10,
                name: "Sra. Carmen Ruiz",
                institution: "USAL",
                role: "Técnico",
                especie: ["Ovina", "Caprina"],
                tecnologia: ["Ciencia de datos", "Detección y medición"],
                lineas: ["Comportamiento animal", "Monitoreo de emisiones"],
                rol: ["Técnico"]
            },
            {
                id: 11,
                name: "Dr. David Pérez",
                institution: "USC/Campus Terra",
                role: "IP",
                especie: ["Vacuna", "Porcina"],
                tecnologia: ["Biosensores", "Análisis de imágenes"],
                lineas: ["Reproducción y mejora genética", "Salud animal"],
                rol: ["IP"]
            },
            {
                id: 12,
                name: "Dra. Isabel Castro",
                institution: "UPV",
                role: "Postdoc",
                especie: ["Avícola", "Cunícula"],
                tecnologia: ["Posicionamiento y navegación", "Automatización y robots"],
                lineas: ["Optimización de recursos", "Comportamiento animal"],
                rol: ["Postdoc"]
            },
            {
                id: 13,
                name: "Sr. Jorge Navarro",
                institution: "CICYTEX",
                role: "Predoc",
                especie: ["Ovina"],
                tecnologia: ["Ciencia de datos"],
                lineas: ["Monitoreo de emisiones"],
                rol: ["Predoc"]
            },
            {
                id: 14,
                name: "Dra. Marta Ortega",
                institution: "CSIC/INIA",
                role: "Asesor científico",
                especie: ["Caprina"],
                tecnologia: ["Detección y medición"],
                lineas: ["Reproducción y mejora genética"],
                rol: ["Asesor científico"]
            },
            {
                id: 15,
                name: "Dr. Andrés Torres",
                institution: "IRTA",
                role: "IP",
                especie: ["Vacuna"],
                tecnologia: ["Biosensores"],
                lineas: ["Salud animal"],
                rol: ["IP"]
            }
        ];
        
        // Initialize visualization
        let svg, simulation;
        const width = document.querySelector('.visualization').clientWidth;
        const height = document.querySelector('.visualization').clientHeight;
        
        function initVisualization() {
            // Clear previous visualization
            d3.select("#network").html("");
            
            // Create SVG container
            svg = d3.select("#network")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // Create tooltip
            const tooltip = d3.select(".tooltip");
            
            // Get filter selections
            const filters = {
                especie: getSelectedFilters('especie'),
                tecnologia: getSelectedFilters('tecnologia'),
                lineas: getSelectedFilters('lineas'),
                rol: getSelectedFilters('rol'),
                institucion: getSelectedFilters('institucion')
            };
            
            // Filter people based on selections
            const filteredPeople = peopleData.filter(person => {
                // Check if person matches any filter in any category
                for (const category in filters) {
                    if (filters[category].length === 0) continue; // Skip if no filters selected
                    
                    if (category === 'institucion') {
                        if (filters[category].includes(person.institution)) return true;
                    } else if (category === 'rol') {
                        if (filters[category].includes(person.role)) return true;
                    } else {
                        // For other categories, check if person has any selected indicator
                        if (person[category].some(indicator => filters[category].includes(indicator))) {
                            return true;
                        }
                    }
                }
                return false;
            });
            
            // Create nodes for visualization
            const nodes = filteredPeople.map(person => ({
                id: person.id,
                name: person.name,
                institution: person.institution,
                role: person.role,
                ...person
            }));
            
            // Create links between people who share any indicator
            const links = [];
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const shared = findSharedIndicators(nodes[i], nodes[j]);
                    if (shared.length > 0) {
                        links.push({
                            source: nodes[i].id,
                            target: nodes[j].id,
                            shared: shared,
                            type: shared[0].category // For coloring
                        });
                    }
                }
            }
            
            // Create force simulation
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(150))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => d.role === "IP" ? 40 : 25));
            
            // Create links
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(links)
                .enter()
                .append("line")
                .attr("stroke", d => getCategoryColor(d.type))
                .attr("stroke-width", 2)
                .attr("stroke-opacity", 0.6);
            
            // Create link labels
            const linkLabels = svg.append("g")
                .attr("class", "link-labels")
                .selectAll("text")
                .data(links)
                .enter()
                .append("text")
                .attr("font-size", 10)
                .attr("fill", d => getCategoryColor(d.type))
                .text(d => d.shared.length > 1 ? `${d.shared[0].indicator} +${d.shared.length-1}` : d.shared[0].indicator);
            
            // Create nodes
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(nodes)
                .enter()
                .append("g");
            
            // Create circles for nodes
            node.append("circle")
                .attr("r", d => d.role === "IP" ? 25 : 18)
                .attr("fill", d => d.role === "IP" ? "#FF9800" : "#64B5F6")
                .attr("stroke", "#fff")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    // Highlight connected nodes
                    link.style("stroke-opacity", l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1);
                    linkLabels.style("opacity", l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1);
                    
                    // Show tooltip
                    tooltip.style("opacity", 1)
                        .html(`
                            <h3>${d.name}</h3>
                            <div class="tooltip-section">
                                <h4>Institución</h4>
                                <p>${d.institution}</p>
                            </div>
                            <div class="tooltip-section">
                                <h4>Rol</h4>
                                <p>${d.role}</p>
                            </div>
                            <div class="tooltip-section">
                                <h4>Especie</h4>
                                <div class="tooltip-indicators">
                                    ${d.especie.map(ind => `<span class="indicator-tag">${ind}</span>`).join('')}
                                </div>
                            </div>
                            <div class="tooltip-section">
                                <h4>Tecnología</h4>
                                <div class="tooltip-indicators">
                                    ${d.tecnologia.map(ind => `<span class="indicator-tag">${ind}</span>`).join('')}
                                </div>
                            </div>
                            <div class="tooltip-section">
                                <h4>Líneas</h4>
                                <div class="tooltip-indicators">
                                    ${d.lineas.map(ind => `<span class="indicator-tag">${ind}</span>`).join('')}
                                </div>
                            </div>
                        `);
                })
                .on("mousemove", function(event) {
                    tooltip.style("left", (event.pageX + 10) + "px")
                           .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    // Reset link opacity
                    link.style("stroke-opacity", 0.6);
                    linkLabels.style("opacity", 1);
                    
                    // Hide tooltip
                    tooltip.style("opacity", 0);
                });
            
            // Add text labels to nodes
            node.append("text")
                .attr("dy", d => d.role === "IP" ? -30 : -25)
                .attr("text-anchor", "middle")
                .attr("fill", "#fff")
                .attr("font-size", d => d.role === "IP" ? 12 : 10)
                .text(d => d.name);
            
            // Add institution labels to nodes
            node.append("text")
                .attr("dy", d => d.role === "IP" ? -15 : -10)
                .attr("text-anchor", "middle")
                .attr("fill", "#ccc")
                .attr("font-size", 9)
                .text(d => d.institution);
            
            // Update positions on each tick
            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                linkLabels.attr("x", d => (d.source.x + d.target.x) / 2)
                         .attr("y", d => (d.source.y + d.target.y) / 2);
                
                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }
        
        // Helper functions
        function getCategoryColor(category) {
            switch(category) {
                case "especie": return "#4CAF50";
                case "tecnologia": return "#2196F3";
                case "lineas": return "#9C27B0";
                case "rol": return "#FF9800";
                case "institucion": return "#F44336";
                default: return "#ccc";
            }
        }
        
        function findSharedIndicators(person1, person2) {
            const shared = [];
            
            // Check especie
            const sharedEspecie = person1.especie.filter(ind => person2.especie.includes(ind));
            sharedEspecie.forEach(ind => shared.push({category: "especie", indicator: ind}));
            
            // Check tecnologia
            const sharedTecnologia = person1.tecnologia.filter(ind => person2.tecnologia.includes(ind));
            sharedTecnologia.forEach(ind => shared.push({category: "tecnologia", indicator: ind}));
            
            // Check lineas
            const sharedLineas = person1.lineas.filter(ind => person2.lineas.includes(ind));
            sharedLineas.forEach(ind => shared.push({category: "lineas", indicator: ind}));
            
            // Check institution
            if (person1.institution === person2.institution) {
                shared.push({category: "institucion", indicator: person1.institution});
            }
            
            // Check role (if they have the same role)
            if (person1.role === person2.role) {
                shared.push({category: "rol", indicator: person1.role});
            }
            
            return shared;
        }
        
        function getSelectedFilters(category) {
            const checkboxes = document.querySelectorAll(`.${category}-content input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function toggleTab(category) {
            const content = document.getElementById(`${category}-content`);
            content.classList.toggle('active');
        }
        
        function toggleAll(category, select) {
            const checkboxes = document.querySelectorAll(`.${category}-content input[type="checkbox"]`);
            checkboxes.forEach(cb => cb.checked = select);
            updateVisualization();
        }
        
        function updateVisualization() {
            initVisualization();
        }
        
        // Set up event listeners for filter changes
        document.querySelectorAll('.filter-option input').forEach(input => {
            input.addEventListener('change', updateVisualization);
        });
        
        // Initialize the visualization
        window.addEventListener('load', () => {
            // Open all tabs by default
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('active');
            });
            
            initVisualization();
        });
    </script>
</body>
</html>